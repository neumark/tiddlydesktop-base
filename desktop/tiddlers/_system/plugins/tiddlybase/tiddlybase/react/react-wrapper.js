/*\
module-type: widget
title: $:/plugins/tiddlybase/react/react-wrapper.js
type: application/javascript
\*/

(()=>{"use strict";var e={783:e=>{e.exports=require("$:/core/modules/widgets/widget.js")},766:e=>{e.exports=require("$:/plugins/tiddlybase/react/components/JSError.js")},922:e=>{e.exports=require("$:/plugins/tiddlybase/react/components/TW5ReactContext.js")},649:e=>{e.exports=require("$:/plugins/tiddlybase/react/react-dom.js")},975:e=>{e.exports=require("$:/plugins/tiddlybase/react/tiddler-removal-detector.js")}},t={};function r(o){var i=t[o];if(void 0!==i)return i.exports;var s=t[o]={exports:{}};return e[o](s,s.exports,r),s.exports}var o={};(()=>{var e=o;Object.defineProperty(e,"__esModule",{value:!0}),e.ReactWrapper=void 0;const t=r(975),i=r(649),s=r(766),n=r(922),{widget:d}=r(783),a=require,l=(e,t)=>(0,s.JSError)({title:t??"Error rendering react component",error:{name:"react-wrapper-error",message:e}});e.ReactWrapper=class extends d{constructor(){super(...arguments),this.onRemovalHandler=void 0}async getRenderable(){const{module:e,export:t="default",...r}=this.attributes;if(!e)return l('Must set "module" widget attribute.');if(!t)return l('Must set "export" widget attribute.');let o;try{o=a(e)}catch(t){return"MODULE_NOT_FOUND"===t?.code?l(`The module '${e}' could not be found.`):(0,s.JSError)({title:"Module require error",error:Object.assign({},t)})}const i=o[t];if(void 0===i)return l(`The module's '${t}' module undefined.`);let d=!1;t.endsWith("Factory")&&(console.log(`react-wrapper: considering export ${t} a factory`),d=!0);try{const e=d?await i({parentWidget:this,...r}):i;return(0,n.withContextProvider)({context:{parentWidget:this},Component:e,props:r})}catch(e){return(0,s.JSError)({error:e})}}render(e,t){this.parentDomNode=e,this.computeAttributes(),this.domNodes?.length>0&&this.removeChildDomNodes();const r=this.document.createElement("div");this.getRenderable().then((e=>this.initReact(e,r))),e.insertBefore(r,t),this.domNodes=[r]}getContainingTiddlerTitle(){let e=this.parentDomNode;for(;e;){const t=e.getAttribute("data-tiddler-title");if(t)return t;e=e.parentElement}return null}destroy(){const e=this.getContainingTiddlerTitle();e&&(0,t.unmonitorRemoval)(e),this.root&&this.root.unmount(),this.root=void 0}removeChildDomNodes(){this.destroy(),super.removeChildDomNodes()}async initReact(e,r){if(r&&(this.root||(this.root=(0,i.createRoot)(r)),e&&this.root.render(e),!this.onRemovalHandler)){const e=this.getContainingTiddlerTitle();e&&(this.onRemovalHandler=e=>(console.log("widget removed, unmounting"),this.destroy(),!0),(0,t.monitorRemoval)(e,this.onRemovalHandler))}}refresh(e){var t=this.computeAttributes();let r=!1;Object.keys(t).length>0&&(console.log("attributes changed, rerendering component"),this.getRenderable().then((e=>this.initReact(e,this.domNodes[0]))),r=!0);const o=this.refreshChildren(e);return r||o}}})();var i=exports;for(var s in o)i[s]=o[s];o.__esModule&&Object.defineProperty(i,"__esModule",{value:!0})})();
//# sourceMappingURL=/sourcemaps/plugins/tiddlybase/react/react-wrapper.js.map